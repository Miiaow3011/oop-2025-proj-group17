import pygame
import sys
import time
from game_state import GameState
from map_manager import MapManager
from player import Player
from ui import UI
from combat import CombatSystem
from inventory import Inventory
from font_manager import font_manager

class Game:
    def __init__(self):
        pygame.init()
        
        # æª¢æŸ¥ä¸­æ–‡å­—é«”
        if not font_manager.install_chinese_font():
            print("è­¦å‘Š: ä¸­æ–‡å­—é«”å¯èƒ½ç„¡æ³•æ­£å¸¸é¡¯ç¤º")
            print("å»ºè­°å°‡ä¸­æ–‡TTFå­—é«”æª”æ¡ˆæ”¾å…¥ assets/fonts/ è³‡æ–™å¤¾")
        
        # éŠæˆ²è¨­å®š
        self.SCREEN_WIDTH = 1024
        self.SCREEN_HEIGHT = 768
        self.FPS = 60
        
        # åˆå§‹åŒ–ç•«é¢
        self.screen = pygame.display.set_mode((self.SCREEN_WIDTH, self.SCREEN_HEIGHT))
        pygame.display.set_caption("æœ«ä¸–ç¬¬äºŒé¤å»³")
        self.clock = pygame.time.Clock()
        
        # éŠæˆ²ç‹€æ…‹
        self.game_state = GameState()
        
        # åˆå§‹åŒ–éŠæˆ²çµ„ä»¶
        self.map_manager = MapManager()
        self.player = Player(x=400, y=300)  # åˆå§‹ä½ç½®åœ¨7-11
        self.ui = UI(self.screen)
        self.combat_system = CombatSystem()
        self.inventory = Inventory()
        
        # éŠæˆ²æ¨™èªŒ
        self.running = True
        self.show_intro = True
        
        # äº’å‹•å†·å»æ©Ÿåˆ¶
        self.last_interaction_time = 0
        self.interaction_cooldown = 0.5  # 0.5ç§’å†·å»æ™‚é–“
        
    def handle_events(self):
        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                self.running = False
                
            elif event.type == pygame.KEYDOWN:
                if self.show_intro:
                    if event.key == pygame.K_SPACE:
                        self.show_intro = False
                        
                elif self.game_state.current_state == "exploration":
                    self.handle_exploration_input(event)
                    
                elif self.game_state.current_state == "combat":
                    self.handle_combat_input(event)
                    
                elif self.game_state.current_state == "dialogue":
                    self.handle_dialogue_input(event)
                
                # å…¨åŸŸå¿«æ·éµ (ä»»ä½•ç‹€æ…‹éƒ½å¯ç”¨)
                if event.key == pygame.K_F1:
                    print(f"é™¤éŒ¯: ç•¶å‰ç‹€æ…‹ = {self.game_state.current_state}")
                    print(f"é™¤éŒ¯: å°è©±æ´»èº = {self.ui.dialogue_active}")
                    print(f"é™¤éŒ¯: ç©å®¶ä½ç½® = ({self.player.x}, {self.player.y})")
                elif event.key == pygame.K_F2:
                    # å¼·åˆ¶æ¢å¾©explorationç‹€æ…‹
                    self.force_exploration_state()
    
    def force_exploration_state(self):
        """å¼·åˆ¶æ¢å¾©åˆ°explorationç‹€æ…‹"""
        print("ğŸ”§ å¼·åˆ¶æ¢å¾©explorationç‹€æ…‹")
        self.game_state.current_state = "exploration"
        self.ui.dialogue_active = False
        self.ui.show_inventory = False
        self.ui.show_map = False
        print("âœ… ç‹€æ…‹å·²æ¢å¾©")
    
    def handle_exploration_input(self, event):
        if event.key == pygame.K_UP:
            self.player.move(0, -32)
        elif event.key == pygame.K_DOWN:
            self.player.move(0, 32)
        elif event.key == pygame.K_LEFT:
            self.player.move(-32, 0)
        elif event.key == pygame.K_RIGHT:
            self.player.move(32, 0)
        elif event.key == pygame.K_SPACE:
            self.interact()
        elif event.key == pygame.K_i:
            self.ui.toggle_inventory()
        elif event.key == pygame.K_m:
            self.ui.toggle_map()
    
    def handle_combat_input(self, event):
        if event.key == pygame.K_1:
            self.combat_system.player_action("attack")
        elif event.key == pygame.K_2:
            self.combat_system.player_action("defend")
        elif event.key == pygame.K_3:
            self.combat_system.player_action("escape")
    
    def handle_dialogue_input(self, event):
        if event.key == pygame.K_1 and len(self.ui.dialogue_options) >= 1:
            self.ui.select_dialogue_option(0)
            self.check_dialogue_end()
        elif event.key == pygame.K_2 and len(self.ui.dialogue_options) >= 2:
            self.ui.select_dialogue_option(1)
            self.check_dialogue_end()
        elif event.key == pygame.K_3 and len(self.ui.dialogue_options) >= 3:
            self.ui.select_dialogue_option(2)
            self.check_dialogue_end()
        elif event.key == pygame.K_SPACE:
            self.ui.continue_dialogue()
            self.check_dialogue_end()
        elif event.key == pygame.K_ESCAPE:
            # ESCéµå¼·åˆ¶é€€å‡ºå°è©±
            self.ui.dialogue_active = False
            self.game_state.current_state = "exploration"
    
    def check_dialogue_end(self):
        """æª¢æŸ¥å°è©±æ˜¯å¦çµæŸï¼Œæ¢å¾©explorationç‹€æ…‹"""
        if not self.ui.dialogue_active:
            self.game_state.current_state = "exploration"
    
    def interact(self):
        # æª¢æŸ¥äº’å‹•å†·å»
        current_time = time.time()
        if current_time - self.last_interaction_time < self.interaction_cooldown:
            print(f"â° äº’å‹•å†·å»ä¸­ï¼Œè«‹ç­‰å¾… {self.interaction_cooldown - (current_time - self.last_interaction_time):.1f} ç§’")
            return
        
        # æª¢æŸ¥ç©å®¶é™„è¿‘æ˜¯å¦æœ‰å¯äº’å‹•ç‰©ä»¶
        current_floor = self.map_manager.get_current_floor()
        interaction = self.map_manager.check_interaction(
            self.player.x, self.player.y, current_floor
        )
        
        print(f"ğŸ” æª¢æŸ¥äº’å‹•: æ¨“å±¤{current_floor}, ä½ç½®({self.player.x}, {self.player.y})")
        
        if interaction:
            print(f"âœ… æ‰¾åˆ°äº’å‹•ç‰©ä»¶: {interaction}")
            self.last_interaction_time = current_time
            
            if interaction["type"] == "shop":
                self.start_shop_interaction(interaction)
            elif interaction["type"] == "npc":
                self.start_npc_dialogue(interaction)
            elif interaction["type"] == "stairs":
                self.use_stairs(interaction)
            elif interaction["type"] == "item":
                self.collect_item(interaction)
        else:
            print("âŒ é™„è¿‘æ²’æœ‰å¯äº’å‹•çš„ç‰©ä»¶")
            # é¡¯ç¤ºé™„è¿‘çš„ç‰©ä»¶ä¾›é™¤éŒ¯
            self.debug_nearby_objects(current_floor)
    
    def debug_nearby_objects(self, floor):
        """é™¤éŒ¯ï¼šé¡¯ç¤ºé™„è¿‘çš„ç‰©ä»¶"""
        floor_data = self.map_manager.floor_data.get(floor, {})
        print(f"ğŸ” {floor}æ¨“é™„è¿‘ç‰©ä»¶:")
        
        # æª¢æŸ¥å•†åº—
        for shop_id, shop in floor_data.get("shops", {}).items():
            distance = ((self.player.x - shop["pos"][0])**2 + (self.player.y - shop["pos"][1])**2)**0.5
            if distance < 100:  # 100åƒç´ å…§
                print(f"  ğŸª {shop_id}: {shop['chinese_name']} - è·é›¢ {distance:.1f}")
        
        # æª¢æŸ¥NPC
        for npc in floor_data.get("npcs", []):
            distance = ((self.player.x - npc["pos"][0])**2 + (self.player.y - npc["pos"][1])**2)**0.5
            if distance < 100:
                print(f"  ğŸ‘¤ {npc['name']} - è·é›¢ {distance:.1f}")
        
        # æª¢æŸ¥ç‰©å“
        for item in floor_data.get("items", []):
            distance = ((self.player.x - item["pos"][0])**2 + (self.player.y - item["pos"][1])**2)**0.5
            if distance < 100:
                print(f"  ğŸ“¦ {item['item']['name']} - è·é›¢ {distance:.1f}")
        
        # æª¢æŸ¥æ¨“æ¢¯
        for stairs in floor_data.get("stairs", []):
            distance = ((self.player.x - stairs["pos"][0])**2 + (self.player.y - stairs["pos"][1])**2)**0.5
            if distance < 100:
                print(f"  ğŸªœ æ¨“æ¢¯({stairs['direction']}) - è·é›¢ {distance:.1f}")
    
    def start_shop_interaction(self, shop_info):
        print(f"ğŸª é€²å…¥å•†åº—: {shop_info['name']}")
        
        # æª¢æŸ¥æ˜¯å¦å·²ç¶“åœ¨å°è©±ä¸­
        if self.game_state.current_state == "dialogue" or self.ui.dialogue_active:
            print("âš ï¸ å·²ç¶“åœ¨å°è©±ä¸­ï¼Œå¿½ç•¥å•†åº—äº’å‹•")
            return
            
        self.game_state.set_state("dialogue")
        self.ui.start_dialogue(shop_info)
    
    def start_npc_dialogue(self, npc_info):
        print(f"ğŸ‘¤ èˆ‡NPCå°è©±: {npc_info['name']}")
        
        # æª¢æŸ¥æ˜¯å¦å·²ç¶“åœ¨å°è©±ä¸­
        if self.game_state.current_state == "dialogue" or self.ui.dialogue_active:
            print("âš ï¸ å·²ç¶“åœ¨å°è©±ä¸­ï¼Œå¿½ç•¥NPCäº’å‹•")
            return
            
        self.game_state.set_state("dialogue")
        self.ui.start_dialogue(npc_info)
    
    def use_stairs(self, stairs_info):
        print(f"ğŸªœ ä½¿ç”¨æ¨“æ¢¯: {stairs_info['direction']}")
        direction = stairs_info["direction"]
        current_floor = self.map_manager.current_floor
        
        if direction == "up":
            if current_floor == 1:
                # 1æ¨“åˆ°2æ¨“ï¼šè‡ªç”±é€šè¡Œ
                self.map_manager.change_floor(2)
                self.player.set_position(400, 600)  # æ¨“æ¢¯åº•éƒ¨
                print("â¬†ï¸ ä¸Šæ¨“åˆ° 2 æ¨“")
                self.ui.show_message("ä¾†åˆ°äº†äºŒæ¨“")
                
            elif current_floor == 2:
                # 2æ¨“åˆ°3æ¨“ï¼šéœ€è¦é‘°åŒ™å¡
                if self.game_state.get_flag("has_keycard") or self.inventory.has_item("é‘°åŒ™å¡"):
                    self.map_manager.change_floor(3)
                    self.player.set_position(400, 600)
                    print("â¬†ï¸ ä½¿ç”¨é‘°åŒ™å¡ä¸Šæ¨“åˆ° 3 æ¨“")
                    self.ui.show_message("ğŸ—ï¸ ä½¿ç”¨é‘°åŒ™å¡é€²å…¥ä¸‰æ¨“ï¼")
                    
                    # è¨­å®šæ¨™è¨˜
                    self.game_state.set_flag("unlocked_third_floor", True)
                else:
                    print("ğŸš« éœ€è¦é‘°åŒ™å¡æ‰èƒ½ä¸Šä¸‰æ¨“")
                    self.ui.show_message("âŒ éœ€è¦é‘°åŒ™å¡æ‰èƒ½é€²å…¥ä¸‰æ¨“ï¼")
                    
            else:
                print("ğŸš« å·²ç¶“åœ¨æœ€é«˜æ¨“å±¤")
                self.ui.show_message("å·²ç¶“æ˜¯æœ€é«˜æ¨“å±¤äº†")
                
        elif direction == "down":
            if current_floor == 3:
                # 3æ¨“åˆ°2æ¨“
                self.map_manager.change_floor(2)
                self.player.set_position(400, 100)  # æ¨“æ¢¯é ‚éƒ¨
                print("â¬‡ï¸ ä¸‹æ¨“åˆ° 2 æ¨“")
                self.ui.show_message("å›åˆ°äº†äºŒæ¨“")
                
            elif current_floor == 2:
                # 2æ¨“åˆ°1æ¨“
                self.map_manager.change_floor(1)
                self.player.set_position(400, 100)
                print("â¬‡ï¸ ä¸‹æ¨“åˆ° 1 æ¨“")
                self.ui.show_message("å›åˆ°äº†ä¸€æ¨“")
                
            else:
                print("ğŸš« å·²ç¶“åœ¨æœ€ä½æ¨“å±¤")
                self.ui.show_message("å·²ç¶“æ˜¯æœ€ä½æ¨“å±¤äº†")
    
    def collect_item(self, item_info):
        print(f"ğŸ“¦ æ”¶é›†ç‰©å“: {item_info['item']['name']}")
        success = self.inventory.add_item(item_info["item"])
        if success:
            self.ui.show_message(f"ç²å¾—äº† {item_info['item']['name']}")
            # å¾åœ°åœ–ä¸Šç§»é™¤ç‰©å“
            self.map_manager.remove_item(item_info["item"])
            print(f"âœ… æˆåŠŸæ”¶é›†: {item_info['item']['name']}")
        else:
            self.ui.show_message("èƒŒåŒ…å·²æ»¿ï¼")
            print(f"âŒ èƒŒåŒ…å·²æ»¿ï¼Œç„¡æ³•æ”¶é›†: {item_info['item']['name']}")
    
    def update(self):
        if not self.show_intro:
            self.player.update()
            self.map_manager.update()
            
            # æª¢æŸ¥éš¨æ©Ÿé­é‡
            if self.game_state.should_trigger_encounter():
                self.start_combat()
    
    def start_combat(self):
        self.game_state.current_state = "combat"
        enemy = self.game_state.get_random_enemy()
        self.combat_system.start_combat(enemy)
    
    def render(self):
        self.screen.fill((0, 0, 0))
        
        if self.show_intro:
            self.render_intro()
        else:
            # æ¸²æŸ“åœ°åœ–
            self.map_manager.render(self.screen)
            
            # æ¸²æŸ“ç©å®¶
            self.player.render(self.screen)
            
            # æ¸²æŸ“UI
            self.ui.render(self.game_state, self.player, self.inventory)
        
        pygame.display.flip()
    
    def render_intro(self):
        intro_text = [
            "ã€Šæœ«ä¸–ç¬¬äºŒé¤å»³ã€‹",
            "",
            "æ²’æœ‰äººçŸ¥é“é€™ä¸€åˆ‡æ˜¯æ€éº¼é–‹å§‹çš„ã€‚",
            "æœ‰ä¸€å¤©ï¼Œä¸€ç¨®å¯æ€•çš„æ®­å±ç—…æ¯’çªç„¶å¸­æ²å…¨çƒã€‚",
            "åªè¦è¢«å’¬å‚·ï¼Œæ„ŸæŸ“è€…ä¾¿æœƒåœ¨ä¸‰åˆ†é˜å…§å¤±å»ç†æ™º...",
            "",
            "å‚³èä¸­ï¼Œä¸€ç¾¤åœ‹ç«‹é™½æ˜äº¤é€šå¤§å­¸çš„å¤©æ‰å­¸ç”Ÿï¼Œ",
            "æ†‘è‘—è¶…å‡¡çš„æ™ºæ…§ï¼Œç ”ç™¼å‡ºäº†ä¸€ç¨®èƒ½å¤ æ²»ç™’ç—…æ¯’çš„ç¥ç§˜è—¥åŠ‘ã€‚",
            "ä»–å€‘å·²å°‡è§£è—¥è—æ–¼äº¤å¤§ç¬¬äºŒé¤å»³ä¸‰æ¨“çš„æŸå€‹éš±å¯†è§’è½...",
            "",
            "è€Œä½ ï¼Œä½œç‚ºåŒæ¨£ä¾†è‡ªäº¤å¤§çš„æ™®é€šå­¸ç”Ÿï¼Œ",
            "åŸæœ¬åªæ˜¯åœ¨ä¾¿åˆ©å•†åº—è²·åˆé¤ï¼Œ",
            "å»åœ¨æ®­å±æ”»é€²æ ¡åœ’çš„ç¬é–“è¢«å›°å…¶ä¸­ã€‚",
            "",
            "ç¾åœ¨ï¼Œå…¨äººé¡çš„å‘½é‹ï¼Œè½åœ¨ä½ æ‰‹ä¸­ã€‚",
            "",
            "æŒ‰ [ç©ºç™½éµ] é–‹å§‹éŠæˆ²"
        ]
        
        y_offset = 50
        for line in intro_text:
            if line:
                text_surface = font_manager.render_text(line, 24, (255, 255, 255))
                text_rect = text_surface.get_rect(center=(self.SCREEN_WIDTH//2, y_offset))
                self.screen.blit(text_surface, text_rect)
            y_offset += 30
    
    def run(self):
        while self.running:
            self.handle_events()
            self.update()
            self.render()
            self.clock.tick(self.FPS)
        
        pygame.quit()
        sys.exit()

def main():
    """ç¨‹å¼å…¥å£é»"""
    try:
        print("ğŸ® å•Ÿå‹•ã€Šæœ«ä¸–ç¬¬äºŒé¤å»³ã€‹")
        game = Game()
        game.run()
    except KeyboardInterrupt:
        print("\nğŸ‘‹ éŠæˆ²è¢«ç”¨æˆ¶ä¸­æ–·")
    except Exception as e:
        print(f"ğŸ’¥ éŠæˆ²ç™¼ç”ŸéŒ¯èª¤: {e}")
        import traceback
        traceback.print_exc()
    finally:
        try:
            pygame.quit()
        except:
            pass

if __name__ == "__main__":
    main()